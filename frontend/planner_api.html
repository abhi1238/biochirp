<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>BioChirp â€” Planner Service Console</title>

  <style>
    :root[data-theme="dark"]{
      --bg0:#0A0F1C; --bg1:#0B1222; --bg2:#0E1626; --bg3:#121C2E;
      --card:#0F1828; --txt:#EAF2FF; --mut:#9FB0C4;
      --brd:rgba(255,255,255,.12); --hover:rgba(255,255,255,.06);
      --accent:#1FA4FF; --accent2:#A78BFA; --ok:#00E38C; --err:#ff6b6b;
      --shadow:0 10px 28px rgba(0,0,0,.28); --ring:rgba(31,164,255,.28);
    }
    :root[data-theme="light"]{
      --bg0:#F6FAFF; --bg1:#FFFFFF; --bg2:#FFFFFF; --bg3:#F1F5FA;
      --card:#FFFFFF; --txt:#0B1624; --mut:#4C6278;
      --brd:rgba(0,0,0,.10); --hover:rgba(0,0,0,.05);
      --accent:#1FA4FF; --accent2:#6D50FF; --ok:#0FB27A; --err:#E25050;
      --shadow:0 8px 22px rgba(17,24,39,.10); --ring:rgba(31,164,255,.22);
    }
    :root{ --chat-max:1080px; --radius:14px; --radius-lg:18px }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh; color:var(--txt); background:var(--bg0);
      font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      display:flex; flex-direction:column;
      background:
        radial-gradient(800px 520px at -20% -10%, rgba(31,164,255,.08) 0%, transparent 60%),
        radial-gradient(800px 520px at 120% 120%, rgba(167,139,250,.08) 0%, transparent 55%),
        linear-gradient(135deg,var(--bg0) 0%,var(--bg1) 100%);
    }
    @media (min-width: 960px){
      .bg-grid{ position:fixed; inset:0; pointer-events:none; z-index:-2; opacity:.08;
        background-image: linear-gradient(to right, var(--brd) 1px, transparent 1px), linear-gradient(to bottom, var(--brd) 1px, transparent 1px);
        background-size: 48px 48px; }
    }

    .app{display:flex; min-height:100vh}
    .chat{flex:1; display:flex; flex-direction:column; min-width:0}

    .chat-header{
      position:sticky; top:0; z-index:5; padding:10px 12px; border-bottom:1px solid var(--brd);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:color-mix(in oklab, var(--bg1) 92%, transparent); backdrop-filter: blur(6px);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0 }
    .brand img{ display:block; width:28px; height:28px }
    .title{ display:flex; flex-direction:column; min-width:0 }
    .title .main{ font-size:16px; font-weight:800; line-height:1 }
    .title .sub{ font-size:12px; font-weight:700; color:var(--mut) }

    .status-wrap{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .connection-status{display:flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--brd); background:var(--bg2); font-size:12px}
    .status-dot{width:9px;height:9px;border-radius:50%}
    .dot.online{background:var(--ok)}
    .dot.offline{background:var(--err)}
    .dot.degraded{background:#ffd76a}

    .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--brd);background:var(--bg2);color:var(--txt);cursor:pointer;font-size:12px}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#00162a; border:none; font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .container{max-width:var(--chat-max); width:100%; margin:0 auto; padding:12px 12px 28px}
    .cards{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width: 980px){ .cards{ grid-template-columns: 1fr 1fr } }

    .card{ border:1px solid var(--brd); background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; transition:border-color .25s ease, transform .25s ease, box-shadow .25s ease }
    .card:hover{ border-color: color-mix(in oklab, var(--accent) 28%, var(--brd)); transform: translateY(-1px) }

    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
    .badge{font-size:11px;padding:3px 8px;border-radius:10px;border:1px solid var(--brd);background:transparent;color:var(--mut);font-weight:700}

    pre{ white-space:pre-wrap; word-break:break-word; background:var(--bg3); color:var(--txt); border:1px solid var(--brd); padding:12px; border-radius:10px; max-height:420px; overflow:auto }
    .pre-head{display:flex; align-items:center; justify-content:space-between; margin:8px 0 0}
    .copy-btn{font-size:11px; padding:3px 8px; border-radius:8px; border:1px solid var(--brd); background:var(--bg2)}
    .copy-btn:hover{ background:var(--hover) }

    :root[data-theme="dark"] .copy-btn{
      background: var(--bg1);
      color: var(--txt);
      border-color: var(--brd);
    }
    :root[data-theme="dark"] .copy-btn:hover{
      background: var(--hover);
    }

    textarea{ width:100%; background:var(--bg3); color:var(--txt); border:1px solid var(--brd); border-radius:10px; padding:10px 12px; min-height:140px; resize:vertical }
    .help{font-size:12px;color:var(--mut);margin-top:6px}
    .kbd{padding:.15rem .35rem;border:1px solid var(--brd);border-radius:.35rem;font-size:.75rem}

    table{width:100%;border-collapse:collapse;border:1px solid var(--brd);border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid var(--brd); text-align:left; padding:8px 10px; font-size:13px}
    thead th{background:var(--bg3); color:var(--mut)}
    .table-wrap{overflow:auto}

    .method{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--brd);background:var(--bg2);font-weight:700}
    .get{color:#ffd76a} .post{color:#63ffb3}

    .field-block{margin-top:10px}
    .field-head{display:flex; align-items:center; gap:6px; font-weight:800}
    .field-sub{display:flex; align-items:center; gap:8px; color:var(--mut); font-size:12px; margin-top:4px}
    .req{color:#f87171}
    .chip{display:inline-block; border:1px solid var(--brd); border-radius:999px; padding:2px 8px; font-size:11px; margin-right:6px; background:var(--bg2)}

    .select{padding:10px 12px;border-radius:10px;border:1px solid var(--brd);background:var(--bg1);color:var(--txt);font-size:13px;min-width:240px}
    .select:focus{outline:2px solid var(--ring)}
    .select.invalid{border-color:#f87171; box-shadow:0 0 0 2px rgba(248,113,113,.25);}

    .warning{display:none; margin-top:8px; padding:8px 10px; border:1px solid var(--brd); border-radius:10px; background:var(--bg2); color:var(--mut)}

    .visually-hidden{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>
<body>
  <div class="bg-grid" aria-hidden="true"></div>
  <div class="app">
    <main class="chat" role="main" aria-labelledby="pageTitle">
      <header class="chat-header">
        <div class="brand">
          <img src="/assets/brand/logo.svg" alt="BioChirp logo" width="28" height="28" loading="eager">
          <div class="title">
            <div id="pageTitle" class="main">Planner Console</div>
            <div class="sub">BioChirp</div>
          </div>
        </div>
        <div class="status-wrap">
          <button class="btn" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">ðŸŒ“ Theme</button>
          <button class="btn" id="pingBtn" title="Ping /health">Ping</button>
          <div class="connection-status" role="status" aria-live="polite">
            <span class="status-dot dot" id="statusDot" aria-hidden="true"></span>
            <span id="connectionStatus">Unknown</span>
          </div>
        </div>
      </header>

      <section class="container">
        <!-- Service Status -->
        <section class="card" aria-labelledby="svcStatusH">
          <div class="row" style="align-items:flex-start">
            <div style="flex:1; min-width:260px">
              <div id="svcStatusH" class="badge">Service Status</div>
              <div class="help" style="margin-top:8px">Health checks run against <code class="mono" id="endpointLabel"></code></div>
              <div id="protoWarn" class="warning">âš  Mixed-content likely: page is <span class="mono" id="pageProto"></span> but API is <span class="mono" id="apiProto"></span>.</div>
              <div id="corsWarn"  class="warning">âš  CORS blocked. Allow this origin or proxy same-origin.</div>
              <div id="fileWarn"  class="warning">âš  Opened via <span class="mono">file://</span>. Serve via HTTP.</div>
              <div id="netWarn"   class="warning">âš  Network error/timeout. Check API reachability.</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <div>
                <div style="font-weight:800" id="statusText">Unknown</div>
                <div class="help" id="statusMeta">â€”</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Schema & Examples -->
        <section class="card" aria-labelledby="schemaH">
          <div class="row">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge" id="schemaH">Schema</span>
              <h3 style="font-size:16px">Input / Output Models</h3>
            </div>
          </div>

          <div class="cards" style="margin-top:10px">
            <!-- Request model -->
            <div class="card" style="padding:12px" aria-labelledby="reqModelH">
              <div class="row">
                <div id="reqModelH" style="font-weight:800">FuzzyFilteredOutputs</div>
                <span class="badge">Body â€¢ JSON</span>
              </div>
              <div class="table-wrap" style="margin-top:8px">
                <table aria-label="FuzzyFilteredOutputs fields">
                  <thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Notes</th></tr></thead>
                  <tbody>
                    <tr><td class="mono">database</td><td class="mono">string</td><td>Yes</td><td>Must match the query param</td></tr>
                    <tr><td class="mono">value</td><td class="mono">OutputFields | null</td><td>No</td><td>Flat biomedical fields</td></tr>
                    <tr><td class="mono">tool</td><td class="mono">string</td><td>Yes</td><td class="mono">"fuzzy"</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="pre-head">
                <div class="help">Example request</div>
                <button class="copy-btn" id="copySingleEx">Copy</button>
              </div>
              <pre class="mono" id="example-input">{
  "database": "ttd",
  "value": {
    "drug_name": "requested",
    "target_name": null,
    "gene_name": null,
    "disease_name": ["tuberculosis"],
    "pathway_name": null,
    "biomarker_name": null,
    "drug_mechanism_of_action_on_target": null,
    "approval_status": null
  },
  "tool": "fuzzy"
}</pre>
            </div>

            <!-- Response model -->
            <div class="card" style="padding:12px" aria-labelledby="respModelH">
              <div class="row">
                <div id="respModelH" style="font-weight:800">PlanGenerator</div>
                <span class="badge">Response â€¢ JSON</span>
              </div>
              <div class="table-wrap" style="margin-top:8px">
                <table aria-label="PlanGenerator fields">
                  <thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Notes / Example</th></tr></thead>
                  <tbody>
                    <tr><td class="mono">database</td><td class="mono">string | null</td><td>No</td><td class="mono">"ttd"</td></tr>
                    <tr><td class="mono">plan</td><td class="mono">any</td><td>Yes</td><td>Planner output (free-form JSON)</td></tr>
                    <tr><td class="mono">tool</td><td class="mono">string | null</td><td>No</td><td class="mono">"planner"</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="pre-head">
                <div class="help">Example response</div>
                <button class="copy-btn" data-copy='{"database":"ttd","plan":{"steps":[{"op":"join","tables":["ttd","synonyms"],"on":"disease_name"}],"rationale":"Match expanded disease synonyms to DB entities"},"tool":"planner"}'>Copy</button>
              </div>
              <pre class="mono" id="example-output">{
  "database": "ttd",
  "plan": {
    "database": "ttd",
    "plan": {
      "tables": [
        "ttd.drug_master_table",
        "ttd.drug_disease_association",
        "ttd.disease_master_table"
      ],
      "parents": {
        "ttd.drug_master_table": null,
        "ttd.drug_disease_association": "ttd.drug_master_table",
        "ttd.disease_master_table": "ttd.drug_disease_association"
      },
      "table_columns": {
        "ttd.drug_disease_association": {
          "concept_columns": [],
          "join_columns": []
        },
        "ttd.disease_master_table": {
          "concept_columns": [
            "disease_name"
          ],
          "join_columns": []
        },
        "ttd.drug_master_table": {
          "concept_columns": [
            "drug_name"
          ],
          "join_columns": []
        }
      },
      "join_pairs": {
        "ttd.drug_master_table,ttd.drug_disease_association": {
          "left_on": [
            "drug_id"
          ],
          "right_on": [
            "drug_id"
          ]
        },
        "ttd.drug_disease_association,ttd.drug_master_table": {
          "left_on": [
            "drug_id"
          ],
          "right_on": [
            "drug_id"
          ]
        },
        "ttd.drug_disease_association,ttd.disease_master_table": {
          "left_on": [
            "disease_id"
          ],
          "right_on": [
            "disease_id"
          ]
        },
        "ttd.disease_master_table,ttd.drug_disease_association": {
          "left_on": [
            "disease_id"
          ],
          "right_on": [
            "disease_id"
          ]
        }
      }
    },
    "tool": "planner"
  },
  "tool": "planner"
}</pre>
            </div>
          </div>
        </section>

        <!-- ORDER: GET /, GET /health, POST /planner -->

        <!-- GET / -->
        <section class="card" aria-labelledby="rootH">
          <div class="row">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="method mono get" aria-hidden="true">GET</span>
              <span id="rootH" class="mono" style="font-weight:800">/</span>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" data-curl="GET /">cURL</button>
              <button class="btn primary" data-try="GET /">Try it</button>
            </div>
          </div>
          <div class="help" style="margin-top:6px"><strong>Purpose:</strong> Service banner.</div>
          <div class="pre-head"><div class="help">Response</div><button class="copy-btn" data-copy-target="#out-root">Copy</button></div>
          <pre id="out-root" class="mono" aria-live="polite"></pre>
        </section>

        <!-- GET /health -->
        <section class="card" aria-labelledby="healthH">
          <div class="row">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="method mono get" aria-hidden="true">GET</span>
              <span id="healthH" class="mono" style="font-weight:800">/health</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" data-curl="GET /health">cURL</button>
              <button class="btn primary" data-try="GET /health">Try it</button>
            </div>
          </div>
          <div class="help" style="margin-top:6px"><strong>Purpose:</strong> Liveness/readiness probe.</div>
          <div class="pre-head"><div class="help">Response</div><button class="copy-btn" data-copy-target="#out-health">Copy</button></div>
          <pre id="out-health" class="mono" aria-live="polite"></pre>
        </section>

        <!-- POST /planner -->
        <section class="card" aria-labelledby="postH">
          <div class="row">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="method mono post" aria-hidden="true">POST</span>
              <span id="postH" class="mono" style="font-weight:800">/planner</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" data-curl="POST /planner">cURL</button>
              <button class="btn" id="fillExample">Fill example</button>
              <button class="btn primary" data-try="POST /planner">Try it</button>
            </div>
          </div>

          <!-- DB selector (required query param) -->
          <div class="field-block">
            <div class="field-head">database <span class="req">*</span></div>
            <div class="field-sub"><span>string</span><span>(query)</span></div>
            <div style="margin-top:6px">
              <label for="dbSel" class="visually-hidden">Database</label>
              <select id="dbSel" class="select" aria-label="Database selector" aria-required="true" aria-invalid="false" required>
                <option value="" selected>Select database</option>
                <option value="ttd">ttd</option>
                <option value="ctd">ctd</option>
                <option value="hcdt">hcdt</option>
              </select>
            </div>
            <div id="dbError" class="field-sub" style="margin-top:6px; display:none; color:#f87171">Please select a database (ttd, ctd, or hcdt).</div>
            <div class="field-sub" style="margin-top:6px">
              <span>Allowed values:</span>
              <span class="chip">ttd</span><span class="chip">ctd</span><span class="chip">hcdt</span>
            </div>
          </div>

          <div class="help" style="margin-top:10px"><strong>Purpose:</strong> Generate a plan for the fuzzy-filtered outputs.</div>

          <div class="cards" style="margin-top:8px">
            <div class="card" style="padding:10px">
              <div class="help">Request body (JSON)</div>
              <textarea id="in-plan" class="mono" placeholder='Click "Fill example" to insert the template.' aria-label="POST /planner request body"></textarea>
              <div class="help">Tip: Press <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to send.</div>
            </div>
            <div class="card" style="padding:10px">
              <div class="pre-head"><div class="help">Response</div><button class="copy-btn" data-copy-target="#out-plan">Copy</button></div>
              <pre id="out-plan" class="mono" aria-live="polite"></pre>
            </div>
          </div>
        </section>

        <!-- Self-tests (toggleable) -->
        <section class="card" aria-labelledby="testsH" id="testsCard" hidden>
          <div class="row">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge" id="testsH">Tests</span>
              <h3 style="font-size:16px">Built-in Self-checks</h3>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="runTests">Run tests</button>
            </div>
          </div>
          <div class="pre-head"><div class="help">Results</div><button class="copy-btn" data-copy-target="#test-out">Copy</button></div>
          <pre id="test-out" class="mono" aria-live="polite"></pre>
        </section>

        <!-- cURL modal -->
        <section id="curlModal" class="card" style="display:none" role="dialog" aria-modal="true" aria-labelledby="curlTitle">
          <div class="row">
            <div id="curlTitle" style="font-weight:800">cURL</div>
            <button class="btn" id="curlClose" aria-label="Close cURL modal">Close</button>
          </div>
          <pre id="curlText" class="mono"></pre>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button class="btn primary" id="curlCopy">Copy</button>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    "use strict";
    // ---------- Config ----------
    // Set to your deployed base (no trailing slash)
    // Example: 'https://biochirp.iiitd.edu.in/services/planner/api'
    const API_BASE = 'https://biochirp.iiitd.edu.in/services/planner/api';
    const DEFAULT_DB = '';              // 'ttd' | 'ctd' | 'hcdt' to preselect
    const REQUIRE_DB_SELECTION = true;  // must choose a DB
    const ENABLE_TESTS = true;          // set to false to hide tests quickly

    // ---------- Single Example JSON (body) ----------
    function singleExampleBody(db) {
      return {
        database: db || "ttd",
        value: {
          drug_name: "requested",
          target_name: null,
          gene_name: null,
          disease_name: ["tuberculosis"],
          pathway_name: null,
          biomarker_name: null,
          drug_mechanism_of_action_on_target: null,
          approval_status: null
        },
        tool: "fuzzy"
      };
    }

    // ---------- DOM helpers ----------
    const $ = (s)=>document.querySelector(s);
    const on = (sel, evt, fn)=>{ const el=$(sel); if (el) el.addEventListener(evt, fn); };

    const statusDot = $('#statusDot');
    const statusText= $('#statusText');
    const statusMeta= $('#statusMeta');
    const connText  = $('#connectionStatus');
    const protoWarn = $('#protoWarn');
    const corsWarn  = $('#corsWarn');
    const fileWarn  = $('#fileWarn');
    const netWarn   = $('#netWarn');
    const pageProto = $('#pageProto');
    const apiProto  = $('#apiProto');
    const endpointLabel = $('#endpointLabel');
    const curlModal = $('#curlModal');
    const curlText  = $('#curlText');

    const fullUrl = (path)=> API_BASE + (path.startsWith('/') ? path : '/'+path);
    const pretty = (o)=>{ try{ return JSON.stringify(o,null,2);}catch{ return String(o);} };

    function setConnStatus(txt, state){
      if (connText) connText.textContent = txt;
      if (!statusDot) return;
      statusDot.classList.remove('online','offline','degraded');
      if (state === true)      statusDot.classList.add('online');
      else if (state === false)statusDot.classList.add('offline');
      else                     statusDot.classList.add('degraded');
    }
    const isMixedContent = ()=> {
      try { return (location.protocol === 'https:' && new URL(API_BASE).protocol === 'http:'); }
      catch { return false; }
    };
    function hideWarnings(){ [protoWarn,corsWarn,fileWarn,netWarn].forEach(x=>{ if(x) x.style.display='none'; }); }

    function requiredDbOrThrow(){
      const dbSel = $('#dbSel');
      const db = dbSel && dbSel.value ? dbSel.value.trim() : '';
      if (REQUIRE_DB_SELECTION && !db) {
        if (dbSel){
          dbSel.classList.add('invalid');
          dbSel.setAttribute('aria-invalid','true');
        }
        const err = $('#dbError'); if (err) err.style.display='block';
        throw new Error('Please select a database (ttd, ctd, or hcdt).');
      }
      return db;
    }
    function buildPostUrl(path){
      const db = requiredDbOrThrow();
      return path + `?database=${encodeURIComponent(db)}`;
    }
    function parseJsonText(text){ if(!text || !text.trim()) return {}; return JSON.parse(text); }

    // ---- fetch with timeout/CORS handling ----
    async function doFetch(urlOrPath, init={}, timeoutMs=45000){
      const url = urlOrPath.startsWith('http') ? urlOrPath : fullUrl(urlOrPath);
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, { cache:'no-store', mode:'cors', signal:ctrl.signal, ...init });
        clearTimeout(t);
        const ct = res.headers.get('content-type') || '';
        const body = ct.includes('application/json') ? await res.json() : await res.text();
        if (!res.ok) {
          console.error('HTTP error', res.status, url, body);
          return { ok:false, status:res.status, body };
        }
        return { ok:true, status:res.status, body };
      }catch(err){
        clearTimeout(t);
        console.error('Fetch failed', url, err);
        const msg = String(err);
        if (msg.includes('TypeError: Failed to fetch')){
          if (location.protocol === 'file:') { if (fileWarn) fileWarn.style.display='block'; }
          else { if (corsWarn) corsWarn.style.display='block'; }
        }else if (msg.includes('AbortError')){ if (netWarn) netWarn.style.display='block'; }
        if (isMixedContent() && protoWarn) protoWarn.style.display='block';
        return { ok:false, body:{ error:msg } };
      }
    }

    // ---- heartbeat ----
    let pingInFlight = false;
    const fmtTime = (d=new Date())=> d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    async function ping(){
      if (pingInFlight) return; pingInFlight = true;
      try{
        const r = await doFetch('/health');
        if (r.ok){ statusText.textContent='Online'; statusMeta.textContent=`HTTP ${r.status} â€¢ ${fmtTime()}`; setConnStatus('Online', true); }
        else      { statusText.textContent='Degraded'; statusMeta.textContent=`${(r.body && (r.body.error||r.status)) || 'Error'} â€¢ ${fmtTime()}`; setConnStatus('Degraded', null); }
      }catch{
        statusText.textContent='Offline'; statusMeta.textContent=`Network/CORS error â€¢ ${fmtTime()}`; setConnStatus('Offline', false);
      }finally{ pingInFlight = false; }
    }

    // ---- actions ----
    async function runGet(path, outSel){
      const out = document.querySelector(outSel); if (out) out.textContent='â€¦';
      try{ const r = await doFetch(path); if(out) out.textContent = pretty(r.body); }
      catch(e){ if(out) out.textContent = pretty({ error:String(e) }); }
    }
    async function runPost(path, inSel, outSel){
      const out = document.querySelector(outSel); if (out) out.textContent='â€¦';

      // ensure DB present and mirror it into body.database
      let db;
      try { db = requiredDbOrThrow(); }
      catch(e){ if(out) out.textContent = pretty({ error:String(e.message||e) }); return; }

      let payload;
      try{ payload = parseJsonText(document.querySelector(inSel).value || '{}'); }
      catch{ if(out) out.textContent = pretty({ error:'Invalid JSON in request body' }); return; }

      // Force body.database to match selected db to avoid mismatch 422s
      if (typeof payload !== 'object' || Array.isArray(payload)) payload = {};
      payload.database = db;
      if (!payload.tool) payload.tool = "fuzzy"; // sensible default

      try{
        const postPath = buildPostUrl(path);
        const r = await doFetch(postPath, { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(payload) });
        if(out) out.textContent = pretty(r.body);
      }catch(e){
        const msg = String(e?.message||e);
        if (msg.includes('Please select a database')) {
          const sel = $('#dbSel'); if (sel){ sel.classList.add('invalid'); sel.setAttribute('aria-invalid','true'); }
          const err = $('#dbError'); if (err) err.style.display='block';
        }
        if(out) out.textContent = pretty({ error: msg });
      }
    }

    function curlFor(kind, path){
      const base = fullUrl(path);
      const db = ($('#dbSel')?.value || '').trim();
      const url = db ? `${base}?database=${encodeURIComponent(db)}` : base;
      if (kind === 'GET')  return `curl -s ${url}`;
      if (kind === 'POST'){
        // Construct a body that mirrors the selected DB
        const selected = ($('#dbSel')?.value || 'ttd');
        let payload;
        try{
          payload = JSON.parse(($('#in-plan')?.value) || '{}');
          if (typeof payload !== 'object' || Array.isArray(payload)) payload = {};
        }catch{ payload = {}; }
        payload.database = selected || "ttd";
        if (!payload.tool) payload.tool = "fuzzy";
        const body = JSON.stringify(payload).replace(/'/g, "'\\''");
        return `printf %s '${body}' | curl -s -X POST ${url} -H 'content-type: application/json' --data-binary @-`;
      }
      return '';
    }
    const copyText = (txt)=>{ try{ navigator.clipboard.writeText(txt); }catch{} };

    // ---- wire UI ----
    on('#pingBtn','click', ping);

    document.querySelectorAll('[data-try]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const [method, path] = btn.dataset.try.split(' ');
        if (method==='GET'  && path==='/')           runGet('/', '#out-root');
        if (method==='GET'  && path==='/health')     runGet('/health', '#out-health');
        if (method==='POST' && path==='/planner')    runPost('/planner', '#in-plan', '#out-plan');
      });
    });

    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
        runPost('/planner', '#in-plan', '#out-plan');
      }
    });

    on('#fillExample','click', ()=>{
      const selDb = ($('#dbSel')?.value) || 'ttd';
      const ta = $('#in-plan');
      if (ta){
        ta.value = JSON.stringify(singleExampleBody(selDb), null, 2);
        window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
      }
    });

    on('#copySingleEx','click', ()=>{
      // Copy the example shown in the schema box (kept static with "ttd")
      const txt = ($('#example-input')?.textContent) || '';
      copyText(txt);
      const btn = $('#copySingleEx'); if (btn){ const old=btn.textContent; btn.textContent='Copied'; setTimeout(()=>btn.textContent=old, 900); }
    });

    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        copyText(btn.getAttribute('data-copy') || '');
        const old = btn.textContent; btn.textContent='Copied'; setTimeout(()=>btn.textContent=old, 900);
      });
    });
    document.querySelectorAll('[data-copy-target]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sel = btn.getAttribute('data-copy-target');
        const el  = document.querySelector(sel);
        copyText(el ? el.textContent : '');
        const old = btn.textContent; btn.textContent='Copied'; setTimeout(()=>btn.textContent=old, 900);
      });
    });

    document.querySelectorAll('[data-curl]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const [method, path] = btn.dataset.curl.split(' ');
        if (curlText) curlText.textContent = curlFor(method, path);
        if (curlModal){
          curlModal.style.display='block';
          window.scrollTo({ top: curlModal.offsetTop - 20, behavior:'smooth' });
        }
      });
    });
    on('#curlClose','click',()=>{ const m = $('#curlModal'); if (m) m.style.display='none'; });
    on('#curlCopy','click',()=> copyText($('#curlText')?.textContent || ''));

    // Theme toggle + persist
    on('#themeToggle','click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      try{ localStorage.setItem('biochirp_theme', next); }catch{}
    });
    (function(){ try{
      const saved = localStorage.getItem('biochirp_theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
    }catch{} })();

    // ---- tests ----
    function runTests(){
      const out = $('#test-out'); const logs = [];
      const ok=(n)=>logs.push('âœ” '+n);
      const fail=(n,e)=>logs.push('âœ˜ '+n+' â€” '+(e?.message||e));

      try{ const o=parseJsonText('{"a":1}'); if(o.a===1) ok('parseJsonText parses valid JSON'); else throw new Error('unexpected'); }
      catch(e){ fail('parseJsonText parses valid JSON', e); }

      try{ const o=parseJsonText(''); if(Object.keys(o).length===0) ok('parseJsonText handles empty string'); else throw new Error('unexpected'); }
      catch(e){ fail('parseJsonText handles empty string', e); }

      try{
        const old = $('#dbSel')?.value; if ($('#dbSel')) $('#dbSel').value='';
        let threw=false; try{ buildPostUrl('/planner'); }catch{ threw=true; }
        if ($('#dbSel')) $('#dbSel').value=old || '';
        if (threw) ok('buildPostUrl enforces database selection'); else throw new Error('did not throw');
      }catch(e){ fail('buildPostUrl enforces database selection', e); }

      try{
        const old = $('#dbSel')?.value; if ($('#dbSel')) $('#dbSel').value='ttd';
        const url = buildPostUrl('/planner');
        if ($('#dbSel')) $('#dbSel').value=old || '';
        if (url.includes('?database=ttd')) ok('buildPostUrl appends ?database'); else throw new Error('missing query');
      }catch(e){ fail('buildPostUrl appends ?database', e); }

      // Body mirroring test
      try{
        const selDb = 'ctd';
        const body = singleExampleBody(selDb);
        if (body.database === 'ctd' && body.tool === 'fuzzy') ok('singleExampleBody mirrors DB + tool');
        else throw new Error('mirror failed');
      }catch(e){ fail('singleExampleBody mirrors DB + tool', e); }

      if (out) out.textContent = logs.join('\n');
    }

    // ---- boot ----
    function start(){
      if (endpointLabel) endpointLabel.textContent = API_BASE;
      if (pageProto) pageProto.textContent = location.protocol.replace(':','');
      try{ if (apiProto) apiProto.textContent = new URL(API_BASE).protocol.replace(':',''); }catch{}
      const dbEl = $('#dbSel'); if (dbEl && DEFAULT_DB){ dbEl.value = DEFAULT_DB; dbEl.classList.remove('invalid'); dbEl.setAttribute('aria-invalid','false'); }
      hideWarnings();
      setInterval(()=>{ if(!document.hidden) ping(); }, 12000);
      ping();
      runGet('/', '#out-root');
      runGet('/health', '#out-health');

      // show/hide tests
      const tCard = $('#testsCard');
      if (tCard) tCard.style.display = ENABLE_TESTS ? '' : 'none';
      if (ENABLE_TESTS) on('#runTests','click', runTests);
    }
    document.addEventListener('DOMContentLoaded', start);

    // Clear DB invalid state on change
    document.addEventListener('change', (e)=>{
      if (e.target?.id === 'dbSel'){
        e.target.classList.remove('invalid');
        e.target.setAttribute('aria-invalid','false');
        const err = $('#dbError'); if (err) err.style.display='none';
      }
    });
  </script>
</body>
</html>
