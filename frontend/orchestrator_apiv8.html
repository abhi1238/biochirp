<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BioChirp - Biological Research AI (Chat)</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
  :root[data-theme="dark"]{ --bg0:#070A15; --bg1:#0B1222; --bg2:#0E1626; --bg3:#121C2E;
    --card:#0F1828; --txt:#EAF2FF; --mut:#9FB0C4; --brd:rgba(255,255,255,.10);
    --hover:rgba(255,255,255,.06); --accent:#1FA4FF; --accent2:#A78BFA; --ok:#00E38C; --err:#ff6b6b; --shadow:0 12px 40px rgba(0,0,0,.35);}
  :root[data-theme="light"]{ --bg0:#F6FAFF; --bg1:#FFFFFF; --bg2:#FFFFFF; --bg3:#F4F7FB;
    --card:#FFFFFF; --txt:#0B1624; --mut:#486173; --brd:rgba(0,0,0,.10);
    --hover:rgba(0,0,0,.04); --accent:#1FA4FF; --accent2:#6D50FF; --ok:#0FB27A; --err:#E25050; --shadow:0 12px 40px rgba(17,24,39,.12);}

  *{box-sizing:border-box;margin:0;padding:0} html,body{height:100%}
  body{min-height:100vh;color:var(--txt);background:var(--bg0);
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;
    background:radial-gradient(900px 600px at -20% -10%, rgba(31,164,255,.10) 0%, transparent 60%),radial-gradient(900px 600px at 110% 110%, rgba(167,139,250,.10) 0%, transparent 55%),linear-gradient(135deg,var(--bg0) 0%,var(--bg1) 100%);}
  a{color:inherit}
  .app{display:flex; min-height:100vh;}

  .sidebar{width:280px;background:var(--bg1);border-right:1px solid var(--brd);padding:16px;display:flex;flex-direction:column;gap:12px;position:relative}
  .logo{display:flex;gap:10px;align-items:center}
  .logo-icon{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 120deg,var(--accent),var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;color:#001726;font-weight:900}
  .logo-text{font-size:20px;font-weight:900;color:var(--accent)}
  .new-conversation-btn{background:var(--bg2);border:1px solid var(--brd);color:var(--accent);padding:12px 14px;border-radius:12px;cursor:pointer;font-size:14px;transition:border-color .2s, transform .1s;}
  .new-conversation-btn:hover{border-color:var(--accent)} .new-conversation-btn:active{transform:translateY(1px)}
  .danger-btn{ background:#1a2536; border-color:#2a3a52; color:#ff9c9c }
  .conversation-list{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto}
  .conversation-item{background:var(--bg2);border:1px solid var(--brd);padding:10px;border-radius:12px;color:var(--txt);font-size:13px;cursor:pointer}
  .conversation-item.active{border-color:var(--accent);background:linear-gradient(135deg,rgba(31,164,255,.10),rgba(167,139,250,.10))}
  .conversation-item small{display:block;color:var(--mut);font-size:11px;margin-top:2px}

  .sidebar-toggle{display:none;border:1px solid var(--brd);background:var(--bg2);color:var(--txt);padding:8px 10px;border-radius:10px;cursor:pointer}
  .drawer{position:fixed;inset:0;display:none;z-index:60}.drawer.show{display:block}
  .drawer-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .drawer-panel{position:absolute;top:0;left:0;height:100%;width:86%;max-width:320px;background:var(--bg1);border-right:1px solid var(--brd);box-shadow:var(--shadow);overflow:auto;transform:translateX(-100%);transition:transform .22s ease}
  .drawer.show .drawer-panel{transform:translateX(0)}

  .chat{flex:1;display:flex;flex-direction:column;min-width:0}
  .chat-header{position:sticky;top:0;z-index:5;padding:12px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;background:color-mix(in oklab, var(--bg1) 90%, transparent);backdrop-filter: blur(6px);gap:10px}
  .leftHdr{display:flex;align-items:center;gap:10px}
  .chat-title{font-size:18px;font-weight:800}.chat-title small{font-weight:700;color:var(--mut)}
  .status-wrap{display:flex;gap:8px;align-items:center}
  .connection-status{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--brd);background:var(--bg2);font-size:12px}
  .status-dot{width:9px;height:9px;border-radius:50%;background:var(--ok)}
  .reconnect,.theme-btn{padding:6px 10px;border-radius:10px;border:1px solid var(--brd);background:var(--bg2);color:var(--txt);cursor:pointer;font-size:12px}
  .reconnect:hover,.theme-btn:hover{background:var(--hover)}

  .messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px}
  .message{display:flex;gap:12px;max-width:900px}
  .message.user{align-self:flex-end;flex-direction:row-reverse}
  .message-avatar{width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--bg2);border:1px solid var(--brd);font-size:18px}
  .message.user .message-avatar{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none}
  .message.assistant .message-avatar{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#00172a;border:none}
  .message-content{flex:1;display:flex;flex-direction:column;gap:8px;min-width:0}
  .timestamp{font-size:11px;color:var(--mut)}
  .message-bubble{padding:14px 16px;border-radius:16px;background:var(--card);border:1px solid var(--brd);line-height:1.6;font-size:15px;box-shadow:var(--shadow);word-wrap:break-word;overflow-wrap:anywhere}
  .message.user .message-bubble{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none}
  .message.assistant .message-bubble pre{background:var(--bg3);border:1px solid var(--brd);border-radius:12px;padding:12px;overflow:auto}
  .message.assistant .message-bubble code{background:var(--bg3);border:1px solid var(--brd);padding:2px 6px;border-radius:6px}
  .copy-btn{position:absolute;top:8px;right:8px;font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid var(--brd);background:var(--bg2);color:var(--txt);cursor:pointer}
  .copy-btn:hover{background:var(--hover)}

  .tool-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden}
  .tool-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
  .tool-info{display:flex;align-items:center;gap:10px}
  .tool-icon{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#00131f;font-size:12px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .tool-name{font-weight:800;font-size:13px;display:flex;align-items:center;gap:6px}
  .tool-status{font-size:11px;padding:4px 8px;border-radius:10px;font-weight:700;border:1px solid var(--brd);background:var(--bg2)}
  .tool-status.running{color:#ffd76a}.tool-status.completed{color:#63ffb3}.tool-status.failed{color:#ff9c9c}
  .tool-time{font-size:11px;padding:4px 8px;border:1px solid var(--brd);background:var(--bg2);color:var(--mut)}
  .expand-icon{transition:.25s;color:var(--mut)}
  .tool-body{max-height:0;overflow:hidden;transition:max-height .3s}
  .tool-card.expanded .tool-body{max-height:520px;overflow:auto}
  .tool-card.show-output .tool-body{max-height:520px;overflow:auto}
  .tool-output{padding:14px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px;white-space:pre-wrap;word-break:break-word}

  .input-area{padding:12px 14px;border-top:1px solid var(--brd);background:color-mix(in oklab, var(--bg1) 92%, transparent);backdrop-filter: blur(6px)}
  .input-container{display:flex;gap:10px;align-items:flex-end;max-width:1100px;margin:0 auto}
  .input-wrapper{flex:1}
  #messageInput{width:100%;min-height:48px;max-height:150px;padding:12px 14px;border-radius:12px;outline:none;resize:none;background:var(--card);border:1px solid var(--brd);color:var(--txt);font-size:14px}
  #messageInput:focus{border-color:var(--accent)}
  #sendButton{width:52px;height:52px;border:none;border-radius:12px;color:#00162a;cursor:pointer;font-size:20px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:var(--shadow)}
  #sendButton:hover{transform:translateY(-1px)} #sendButton:disabled{opacity:.5;cursor:not-allowed}

  .samples{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:8px 0 2px;width:100%}
  .sample-chip{width:100%;text-align:left;padding:10px 12px;white-space:normal}
  .sample-chip:hover{background:var(--hover)}

  @media (max-width: 1024px){ .sidebar{display:none} .sidebar-toggle{display:inline-flex;align-items:center;gap:6px} }
  @media (max-width: 640px){ .chat-title{font-size:16px} .message-bubble{font-size:14px;padding:12px 12px}
    .message-avatar{width:32px;height:32px;font-size:16px;border-radius:10px} .copy-btn{font-size:11px;padding:5px 7px}
    .connection-status{display:none}}
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  .tool-card,.tool-card .tool-header,.tool-card .tool-body,.tool-card .tool-output,.tool-card table{background:#fff!important;color:#222!important}
  .tool-card{border:1px solid #e6e6e6!important;box-shadow:0 2px 12px rgba(0,0,0,0.06)}
  .tool-card th,.tool-card td{background:#fff!important;color:#222!important;border-bottom:1px solid #eee}
  .message-avatar{background:#fff!important;border:none!important;box-shadow:none!important}
  .message-avatar img{background:transparent!important}
  .tool-icon{background:#fff!important;border:none!important}

  html,body{height:100%} .app{height:100dvh;min-height:100dvh}
  .chat{display:flex;flex-direction:column;min-width:0;height:100%}
  .chat-header{position:sticky;top:0;z-index:5}
  .messages{flex:1 1 auto;min-height:0;overflow-y:auto;-webkit-overflow-scrolling:touch}
  .input-area{flex-shrink:0;position:sticky;bottom:0;padding-bottom:calc(env(safe-area-inset-bottom,0px)+12px);background:color-mix(in oklab, var(--bg1) 92%, transparent);backdrop-filter:blur(6px)}
  .sidebar{height:100dvh;overflow-y:auto}
  @media (max-width:1024px){ .sidebar{display:none} .drawer .sidebar{height:100%} .drawer-panel{max-width:92vw} }
  .tool-output,.message-bubble{overflow-wrap:anywhere}
  .message .message-content{align-items:stretch}
</style>
</head>
<body>
<!-- Mobile drawer -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer-panel">
    <div class="sidebar" style="width:100%; border:none; height:100%;">
      <div class="logo" style="justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="logo-icon">
            <img src="assets/brand/logo.svg" alt="My Logo" style="width:32px;height:32px;border-radius:8px;">
          </div>
          <div class="logo-text">BioChirp</div>
        </div>
        <button id="drawerClose" class="sidebar-toggle" title="Close">‚úï</button>
      </div>
      <button class="new-conversation-btn" onclick="startNewConversation()">+ New Conversation</button>
      <button class="new-conversation-btn danger-btn" data-action="clear-chat">üóë Delete Chat</button>
      <div id="sessionListMobile" class="conversation-list"></div>
    </div>
  </aside>
</div>

<div class="app">
  <!-- Desktop sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon" aria-label="BioChirp Logo">
        <img src="assets/brand/logo.svg" alt="BioChirp Logo">
      </div>
      <div class="logo-text">BioChirp</div>
    </div>

    <button class="new-conversation-btn" onclick="startNewConversation()">+ New Conversation</button>
    <button class="new-conversation-btn danger-btn" data-action="clear-chat">üóë Delete Chat</button>
    <div id="sessionList" class="conversation-list"></div>
  </aside>

  <!-- Chat -->
  <main class="chat">
    <header class="chat-header">
      <div class="leftHdr">
        <button id="drawerOpen" class="sidebar-toggle" title="Menu">‚ò∞ Menu</button>
        <div class="chat-title">Research Chat <small>‚Ä¢ Biological Intelligence</small></div>
      </div>
      <div class="status-wrap">
        <button class="theme-btn" id="themeToggle" title="Toggle theme">üåì Theme</button>
        <button class="reconnect" id="shareBtn" title="Share this chat" onclick="shareCurrentSession()">üîó Share</button>
        <button class="reconnect" id="reconnectBtn" onclick="manualReconnect()">Reconnect</button>
        <div class="connection-status"><div class="status-dot" id="statusDot"></div><span id="connectionStatus">Connecting‚Ä¶</span></div>
      </div>
    </header>

    <section class="messages" id="messagesContainer">
      <div class="message assistant">
        <div class="message-avatar" title="Assistant">
          <img src="assets/brand/logo.svg" alt="Assistant" style="width:100%;height:100%;border-radius:12px;">
        </div>
        <div class="message-content">
          <div class="timestamp" id="welcomeTs"></div>
          <div class="message-bubble" id="welcomeMsg">Welcome to **BioChirp**! Ask about drugs, disease, pathways, biomarkers.</div>
          <div class="samples">
            <button class="sample-chip" onclick="askSample('What are the drugs for TB?')"> üíä What are the drugs for TB?</button>
            <button class="sample-chip" onclick="askSample('Which genes are associated with asthma?')"> üß¨ Which genes are associated with asthma?</button>
            <button class="sample-chip" onclick="askSample('List all PARP inhibitors with targets and approval status')"> üß™ What biomarkers and pathways are associated with melanoma</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="input-area">
      <div class="input-container">
        <div class="input-wrapper">
          <textarea id="messageInput" placeholder="Ask about drugs, pathways, clinical data..." rows="1"></textarea>
        </div>
        <button id="sendButton" title="Send" onclick="sendMessage()">‚û§</button>
      </div>
    </footer>
  </main>
</div>

<script>
  // ===== WebSocket URL (auto-detect with optional ?ws= override) =====

  const WS_URL='wss://www.biochirp.net/chat';
  // const WS_URL = (() => {
  //   const params = new URLSearchParams(location.search);
  //   const override = params.get('ws');
  //   if (override) return override; // e.g., ?ws=wss://biochirp.net/chat
  //   const isHttps = location.protocol === 'https:';
  //   const fromOrigin = (isHttps ? 'wss://' : 'ws://') + location.host + '/chat';
  //   const devLocal   = 'wss://localhost:8010/chat';
  //   return (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  //     ? devLocal
  //     : fromOrigin;
  // })();

  function uid(){ return Date.now().toString(); }

  marked.setOptions({ gfm:true, breaks:true, mangle:false, headerIds:false,
    highlight:(code,lang)=>{ try{return hljs.highlight(code,{language:lang}).value;}catch{return hljs.highlightAuto(code).value;} } });

  const themeBtn = document.getElementById('themeToggle');
  function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); try{ localStorage.setItem('biochirp_theme', t); }catch(e){} }
  (function initTheme(){
    const saved = (()=>{ try{ return localStorage.getItem('biochirp_theme'); }catch(e){ return null; } })();
    if (saved) applyTheme(saved); else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark ? 'dark':'light'); }
  })();
  themeBtn?.addEventListener('click', ()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; applyTheme(cur==='dark'?'light':'dark'); });

  const drawer = document.getElementById('drawer');
  document.getElementById('drawerOpen')?.addEventListener('click', ()=> drawer.classList.add('show'));
  document.getElementById('drawerClose')?.addEventListener('click', ()=> drawer.classList.remove('show'));
  document.getElementById('drawerBackdrop')?.addEventListener('click', ()=> drawer.classList.remove('show'));

  let ws=null, pingInterval=null;
  let currentAssistantMessage=null;
  let currentToolCards=new Map();
  let isWaiting=false;
  let orchestratorBuf='';
  let toolBuffers=new Map();
  let toolCount=0;
  let suppressOrchStream=true;

  const toolStartTimes = new Map();
  let runTotalStart = null;
  let runTotalSum   = 0;

  const primaryByName = new Map();
  const aliasToPrimary = new Map();
  const nameKey = (n)=> String(n||'tool').trim().toLowerCase();
  const getPrimaryId = (id)=> aliasToPrimary.get(id) || id;

  function setStatus(t,ok){ document.getElementById('connectionStatus').textContent=t; document.getElementById('statusDot').style.background=ok?'var(--ok)':'var(--err)'; }
  function startPing(){ cleanupPing(); pingInterval=setInterval(()=>{ if(ws&&ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'ping',ts:Date.now()})); },30000); }
  function cleanupPing(){ if(pingInterval){ clearInterval(pingInterval); pingInterval=null; } }
  function nowStamp(){ return new Date().toLocaleString(); }
  function scrollEnd(){ const mc=document.getElementById('messagesContainer'); mc.scrollTop=mc.scrollHeight; }
  function esc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
  const fmtMs = (ms)=> ms<1000 ? `${Math.round(ms)} ms` : `${(ms/1000).toFixed(2)} s`;

  function connect(){
    cleanupPing();
    try{ ws && ws.close(); }catch{}
    ws=new WebSocket(WS_URL);
    ws.onopen=()=>{ setStatus('Connected',true); startPing(); };
    ws.onclose=()=>{ setStatus('Disconnected',false); cleanupPing(); setTimeout(connect,2000); };
    ws.onerror=()=>{ setStatus('Error',false); };
    ws.onmessage=(e)=>{ try{ route(JSON.parse(e.data)); }catch{} };
  }
  function manualReconnect(){ try{ if(ws) ws.close(); }catch{} connect(); }

  window.addEventListener('load', ()=>{
    try { localStorage.removeItem(SESS_KEY); localStorage.removeItem(CURR_KEY); } catch {}
    const wm=document.getElementById('welcomeMsg');
    if(wm){ wm.innerHTML=marked.parse(wm.textContent||wm.innerHTML); document.getElementById('welcomeTs').textContent=nowStamp(); }
    connect();
    document.querySelectorAll('[data-action="clear-chat"]').forEach(btn=> btn.addEventListener('click', deleteChat));
    renderSessionLists();
    restoreHistory();
  });

  function createAssistant() {
    const el = document.createElement('div');
    el.className = 'message assistant';
    el.innerHTML = `
      <div class="message-avatar" title="Assistant">
        <img src="assets/brand/logo.svg" alt="Assistant" style="width:100%;height:100%;border-radius:12px;">
      </div>
      <div class="message-content">
        <div class="timestamp">${nowStamp()}</div>
        <div class="message-bubble"></div>
      </div>
    `;
    document.getElementById('messagesContainer').appendChild(el);
    return el;
  }

  function mainBubble(msgDiv){
    const mc=msgDiv.querySelector('.message-content');
    let b=[...mc.querySelectorAll('.message-bubble')].find(x=>!x.closest('.tool-card'));
    if(!b){ b=document.createElement('div'); b.className='message-bubble'; mc.appendChild(b); }
    return b;
  }
  function ensureRunSummary(){
    if(!currentAssistantMessage) return null;
    const mc = currentAssistantMessage.querySelector('.message-content');
    let summary = mc.querySelector('.run-summary');
    if(!summary){
      summary = document.createElement('div');
      summary.className = 'run-summary';
      summary.style.cssText = 'margin:6px 0 2px;font-size:12px;color:var(--mut)';
      mc.appendChild(summary);
    }
    return summary;
  }
  function updateRunSummary(final=false){
    const node = ensureRunSummary(); if(!node) return;
    const wall = (runTotalStart!=null) ? (performance.now()-runTotalStart) : 0;
    node.textContent = `‚Ä¢ Total-answer-time: ${fmtMs(wall)}`;
  }

  function enhanceCode(scope){
    scope.querySelectorAll('pre code').forEach(code=>{
      const pre=code.closest('pre');
      if(!pre.querySelector('.copy-btn')){
        const btn=document.createElement('button'); btn.className='copy-btn'; btn.textContent='Copy';
        btn.onclick=async()=>{ try{ await navigator.clipboard.writeText(code.textContent); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',1200);}catch{} };
        pre.style.position='relative'; pre.appendChild(btn);
      }
    });
  }

  function toolClass(n){ n=(n||'').toLowerCase();
    if(n.includes('ttd'))return'tool-ttd'; if(n.includes('ctd'))return'tool-ctd'; if(n.includes('hcdt'))return'tool-hcdt';
    if(n.includes('web'))return'tool-web'; if(n.includes('interpreter'))return'tool-interpreter'; return'tool-generic'; }
  function toolEmoji(n){ n=(n||'').toLowerCase();
    if(n.includes('ttd'))return'üéØ'; if(n.includes('ctd'))return'üß™'; if(n.includes('hcdt'))return'üíä';
    if(n.includes('web'))return'üåê'; if(n.includes('interpreter'))return'üß†'; if(n.includes('readme'))return'üìñ'; return'üõ†Ô∏è'; }

  function createToolCard(id, name){
    const icon = toolEmoji(name);
    const c = document.createElement('div');
    c.className = `tool-card ${toolClass(name)}`;
    c.dataset.toolId = id;
    c.innerHTML = `
      <div class="tool-header" onclick="toggleCard(this)">
        <div class="tool-info">
          <div class="tool-icon" aria-hidden="true">${icon}</div>
          <div class="tool-name">${esc(name || 'Tool')}</div>
          <div class="tool-status running">Running‚Ä¶</div>
          <div class="tool-time" id="time-${id}" title="Time taken">‚Äî</div>
        </div>
        <div class="expand-icon">‚ñæ</div>
      </div>
      <div class="tool-body"><div class="tool-output"></div></div>
    `;
    return c;
  }

  function toggleCard(h){
    const c = h.closest('.tool-card');
    c.classList.toggle('expanded');
    c.classList.remove('show-output');
  }

  // ===== CSV Dock (TTD/CTD/HCDT) =====
  function renderDbCsvDock(msgEl){
    if (!msgEl) return;
    const mc = msgEl.querySelector('.message-content'); if (!mc) return;

    const existing = mc.querySelector('.csv-dock'); if (existing) existing.remove();

    const sources = [
      { key:'ttd',  label:'Therapeutic Target Database'  },
      { key:'ctd',  label:'Comparative Toxicogenomics Database'  },
      { key:'hcdt', label:'Highly Confident Drug Target Database' },
    ].filter(s => msgEl.dataset[`csv_${s.key}`]);

    if (!sources.length) return;

    const dock = document.createElement('div');
    dock.className = 'csv-dock';
    dock.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:10px 0 0;';

    for (const s of sources) {
      const csv  = msgEl.dataset[`csv_${s.key}`];
      const name = msgEl.dataset[`csvname_${s.key}`] || `${s.key}.csv`;

      const frame = document.createElement('div');
      frame.className = 'csv-frame';
      frame.style.cssText = 'background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:10px;';

      frame.innerHTML = `
        <div style="font-weight:800;margin-bottom:8px">${s.label}</div>
        <div class="csv-actions">
          <button class="btn btn-copy" title="Copy ${s.label}" aria-label="Copy ${s.label}">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M16 3H8a2 2 0 0 0-2 2v10h2V5h8V3z"></path>
              <path d="M16 7h-6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V13l-6-6zM20 19H10V9h5v5h5v5z"></path>
            </svg>
            <span>Copy</span>
          </button>
          <button class="btn btn-download" title="Download ${s.label}" aria-label="Download ${s.label}">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M12 3v10m0 0 4-4m-4 4-4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Download</span>
          </button>
        </div>
      `;

      const copyBtn = frame.querySelector('.btn-copy');
      const dlBtn   = frame.querySelector('.btn-download');

      copyBtn.onclick = (ev) => {
        ev.stopPropagation();
        navigator.clipboard.writeText(csv).then(()=>{
          const orig = copyBtn.innerHTML;
          copyBtn.innerHTML = '‚úÖ Copied';
          setTimeout(()=> copyBtn.innerHTML = orig, 900);
        });
      };

      dlBtn.onclick = (ev) => {
        ev.stopPropagation();
        saveCSV(name, csv);
      };

      dock.appendChild(frame);
    }

    const lastTool = mc.querySelector('.tool-card:last-child');
    const insertAfter = lastTool || mc.querySelector('.message-bubble:last-of-type');
    if (insertAfter) insertAfter.after(dock); else mc.appendChild(dock);
  }

  function saveCSV(filename, csvText) {
    try {
      const blob = new Blob(["\ufeff" + csvText], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
      return;
    } catch (e) {}
    const url = 'data:text/csv;charset=utf-8,' + encodeURIComponent("\ufeff" + csvText);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.rel = 'noopener'; document.body.appendChild(a);
    a.click(); setTimeout(() => a.remove(), 0);
  }

  function renderToolOutput(card, output, toolName){
    const outEl = card.querySelector('.tool-output');
    const toolKey = String(toolName||'').toLowerCase();
    const isDbTool = toolKey.includes('ttd') || toolKey.includes('ctd') || toolKey.includes('hcdt');

    let parsed=null;
    if (typeof output==='string'){ try{ parsed = JSON.parse(output); }catch{} }
    else if (output && typeof output==='object'){ parsed = output; }

    const safe = (obj)=>obj && typeof obj==='object' ? obj : {};
    const maybeItem = safe(parsed?.item);
    const maybeOut  = safe(maybeItem.output);
    const messageToUser = parsed?.message_to_user || maybeItem?.message_to_user || maybeOut?.message_to_user || '';

    const rows = isDbTool ? (extractTableArray(output) || extractTableArray(parsed) || extractTableArray(maybeOut)) : null;

    if (isDbTool){
      if (Array.isArray(rows) && rows.length){
        const csv = toCSV(rows);
        const fname = (toolKey || 'table') + '.csv';
        card.dataset.csv = csv;
        card.dataset.csvFilename = fname;

        const msg = card.closest('.message.assistant');
        if (msg) {
          const which =
            toolKey.includes('ttd')  ? 'ttd'  :
            toolKey.includes('ctd')  ? 'ctd'  :
            toolKey.includes('hcdt') ? 'hcdt' : null;
          if (which) {
            msg.dataset[`csv_${which}`]     = csv;
            msg.dataset[`csvname_${which}`] = `${which}.csv`;
          }
        }

        const countBar = `<div style="font-size:12px;color:var(--mut);margin:2px 0 6px;">${rows.length} row(s) returned</div>`;
        outEl.innerHTML = countBar +
          `<div style="display:flex;gap:8px;align-items:center;margin:4px 0 10px;">
            <button class="reconnect" onclick="copyCSVFromCard(this)">Copy CSV</button>
            <button class="reconnect" onclick="downloadCSVFromCard(this)">Download CSV</button>
          </div>` + tableHtml(rows, 'Results');
        return;
      } else {
        const msg = esc(messageToUser || 'No rows returned.');
        outEl.innerHTML = `<div style="font-size:13px;color:var(--mut);padding:6px 2px">${msg}</div>`;
        return;
      }
    }

    let obj=null; 
    if (typeof output==='string') { try { obj = JSON.parse(output); } catch {} }
    else if (output && typeof output==='object') { obj = output; }
    if (obj) obj = redactEchoFields(obj);

    outEl.innerHTML = obj ? esc(JSON.stringify(obj, null, 2))
                          : esc(typeof output==='string' ? output : JSON.stringify(output,null,2));
  }

  function tableHtml(arr,caption){
    if(!Array.isArray(arr)||!arr.length) return `<div style="color:var(--mut);font-style:italic;padding:6px 2px">[Empty Table]</div>`;
    const cols=Object.keys(arr[0]);
    const thead=`<thead><tr>${cols.map(k=>`<th style="position:sticky;top:0;background:var(--bg3);color:var(--txt);padding:10px 12px;border-bottom:1px solid var(--brd);text-align:left;font-size:13px">${esc(k.replace(/_/g,' '))}</th>`).join('')}</tr></thead>`;
    const tbody=arr.map(r=>`<tr>${cols.map(c=>`<td style="padding:9px 12px;border-bottom:1px solid var(--brd)"><div style="max-width:360px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(String(r[c]??''))}">${esc(String(r[c]??''))}</div></td>`).join('')}</tr>`).join('');
    const cap=caption?`<caption style="text-align:left;color:var(--accent);padding:8px 6px 6px;font-weight:800">üîé ${esc(caption)}</caption>`:'';
    return `<div style="width:100%;overflow:auto;margin:.4em 0 .8em 0"><table style="border-collapse:separate;border-spacing:0;width:100%;background:var(--card);border:1px solid var(--brd);border-radius:11px">${cap}${thead}<tbody>${tbody}</tbody></table></div>`;
  }

  function sanitizeOrchestrator(content){
    if (!content) return '';
    const t = content.trim();
    const startsWithEcho = /^\s*`{0,3}\s*"?input[_ ]?query"?\s*[:=>]/i.test(t);
    const shortEcho = t.length <= 500 && /input[_ ]?query/i.test(t) && !/\n.*\n.*\n/.test(t);
    const fencedEcho = /^```[\s\S]*?input[_ ]?query[\s\S]*?```$/i.test(t) && !/```[\s\S]*?```[\s\S]*?```/i.test(t);
    return (startsWithEcho || shortEcho || fencedEcho) ? '' : content;
  }
  function redactEchoFields(obj){
    const BAN = new Set(['inputquery','input_query','raw_input','query','prompt','args','kwargs','messages']);
    if (Array.isArray(obj)) return obj.map(redactEchoFields);
    if (obj && typeof obj === 'object') {
      const out = {};
      for (const [k,v] of Object.entries(obj)) {
        if (BAN.has(String(k).toLowerCase())) continue;
        out[k] = redactEchoFields(v);
      }
      return out;
    }
    return obj;
  }

  function onOrchDelta(text){
    if (suppressOrchStream || toolCount > 0) return;
    if (!text) return;
    const maybe = sanitizeOrchestrator(text); if (!maybe) return;

    if (!currentAssistantMessage){ currentAssistantMessage = createAssistant(); orchestratorBuf = ''; }
    const bubble = mainBubble(currentAssistantMessage);

    if (orchestratorBuf && maybe.startsWith(orchestratorBuf)) orchestratorBuf = maybe; else orchestratorBuf += maybe;

    bubble.innerHTML = marked.parse(orchestratorBuf) + `<span style="display:inline-block;width:2px;height:1em;background:var(--accent);margin-left:2px;animation:blink 1s infinite"></span>`;
    bubble.querySelectorAll('pre code').forEach(c => hljs.highlightElement(c));
    enhanceCode(bubble);
    scrollEnd();
  }

  function onOrchFinal(text){
    const cleaned = sanitizeOrchestrator(text);
    if (!cleaned) { suppressOrchStream = false; return; }
    if (!currentAssistantMessage) currentAssistantMessage = createAssistant();
    const bubble = mainBubble(currentAssistantMessage);
    bubble.innerHTML = marked.parse(cleaned);
    bubble.querySelectorAll('pre code').forEach(c=>hljs.highlightElement(c));
    enhanceCode(bubble);
    saveTurn('assistant', cleaned);
    orchestratorBuf = '';
    suppressOrchStream = false;
    scrollEnd();
  }

  function route(d) {
    switch (d.type) {
      case 'heartbeat':
      case 'pong':
      case 'user_ack':
        break;

      case 'orchestrator_delta':
        onOrchDelta(d.content);
        break;

      case 'orchestrator_message':
        break;

      case 'orchestrator_final': {
        const cleaned = sanitizeOrchestrator(d.content);
        if (!cleaned) { suppressOrchStream = false; return; }
        if (!currentAssistantMessage) currentAssistantMessage = createAssistant();
        const bubble = mainBubble(currentAssistantMessage);
        bubble.innerHTML = marked.parse(cleaned);
        bubble.querySelectorAll('pre code').forEach(c => hljs.highlightElement(c));
        enhanceCode(bubble);
        saveTurn('assistant', cleaned);
        orchestratorBuf = '';
        suppressOrchStream = false;
        scrollEnd();
        break;
      }

      case 'Tool called': {
        toolCount++;
        suppressOrchStream = true;
        const toolName = d.item?.raw_item?.name || 'Tool';
        const key = nameKey(toolName);
        const incomingId = d.tool_id;

        if (runTotalStart == null) runTotalStart = performance.now();
        toolStartTimes.set(incomingId, performance.now());

        if (!currentAssistantMessage) currentAssistantMessage = createAssistant();

        if (primaryByName.has(key)) {
          const primaryId = primaryByName.get(key);
          aliasToPrimary.set(incomingId, primaryId);
          toolBuffers.set(incomingId, '');
          scrollEnd();
          break;
        }

        const card = createToolCard(incomingId, toolName);
        currentToolCards.set(incomingId, card);
        primaryByName.set(key, incomingId);
        toolBuffers.set(incomingId, '');

        const mc = currentAssistantMessage.querySelector('.message-content');
        const main = mc.querySelector('.message-bubble:not(.tool-card .message-bubble)');
        if (main) mc.insertBefore(card, main); else mc.appendChild(card);

        updateRunSummary();
        scrollEnd();
        break;
      }

      case 'Tool output': {
        const idRaw = d.tool_id;
        const id = getPrimaryId(idRaw);
        const out = d.item?.output;
        const prev = toolBuffers.get(id) || '';
        if (typeof out === 'string') toolBuffers.set(id, prev + out);
        else if (out && typeof out === 'object') toolBuffers.set(id, prev + JSON.stringify(out, null, 2));
        else toolBuffers.set(id, prev + String(out ?? ''));
        break;
      }

      case 'tool_result': {
        const idRaw = d.tool_id;
        const id = getPrimaryId(idRaw);
        const card = currentToolCards.get(id);
        if (card) {
          const st = card.querySelector('.tool-status');
          if (st) {
            st.textContent = d.ok ? 'Completed (tap to view)' : 'Failed';
            st.className = `tool-status ${d.ok ? 'completed' : 'failed'}`;
          }
          const buf = toolBuffers.get(id) || '';
          renderToolOutput(card, buf, card.querySelector('.tool-name')?.textContent || '');
          card.classList.add('expanded', 'show-output');

          const started = toolStartTimes.get(idRaw) ?? toolStartTimes.get(id) ?? null;
          if (started != null) {
            const dt = performance.now() - started;
            runTotalSum += dt;
            const tEl = card.querySelector(`#time-${id}`);
            if (tEl) tEl.textContent = fmtMs(dt);
            updateRunSummary();
          }

          setTimeout(() => { card.classList.remove('expanded', 'show-output'); }, 3000);

          const name = card.querySelector('.tool-name')?.textContent || 'Tool';
          const key = nameKey(name);
          if (primaryByName.get(key) === id) primaryByName.delete(key);

          const msg = card.closest('.message.assistant');
          if (msg) renderDbCsvDock(msg);
        }
        toolCount = Math.max(0, toolCount - 1);
        break;
      }

      case 'ttd_table': {
        if (!currentAssistantMessage) currentAssistantMessage = createAssistant();
        const mc = currentAssistantMessage.querySelector('.message-content');

        const {columns, rows, csv, csv_name} = d;
        if (!Array.isArray(rows) || !rows.length) {
          mc.insertAdjacentHTML('beforeend', `<div style="color:var(--mut);font-style:italic;margin-top:12px">[No rows]</div>`);
          break;
        }

        const thead = `<tr>${columns.map(c=>`<th>${esc(c)}</th>`).join('')}</tr>`;
        const tbody = rows.map(r=>`<tr>${
        columns.map(c=>`<td title="${esc(r[c] ?? '')}">${esc(r[c] ?? '')}</td>`).join('')
        }</tr>`).join('');

        // const tbody = rows.map(r=>`<tr>${columns.map(c=>`<td title="${esc(r[c]||'']}">${esc(r[c]||''])}</td>`).join('')}</tr>`).join('');
        const table = `<div style="width:100%;overflow:auto;margin:.4em 0 .8em 0">
                         <table style="border-collapse:separate;border-spacing:0;width:100%;background:var(--card); border:1px solid var(--brd);border-radius:11px">
                           <thead style="background:var(--bg3);">${thead}</thead>
                           <tbody>${tbody}</tbody>
                         </table>
                       </div>`;

        const lastTool = mc.querySelector('.tool-card:last-child') || mc.querySelector('.message-bubble:last-of-type');
        const wrapper = document.createElement('div');
        wrapper.style.marginTop = '12px';
        wrapper.innerHTML = `<div style="font-weight:800;color:var(--accent);margin-bottom:6px">TTD Results (${rows.length} row${rows.length>1?'s':''})</div>${table}`;
        (lastTool ? lastTool.after(wrapper) : mc.appendChild(wrapper));

        if (csv) storeCsvOnMessage(currentAssistantMessage, 'ttd', csv, csv_name || 'ttd.csv');
        renderDbCsvDock(currentAssistantMessage);
        break;
      }

      case 'final':
        onFinalTurn();
        updateRunSummary(true);
        runTotalStart = null; runTotalSum = 0; toolStartTimes.clear();
        suppressOrchStream = true;
        if (currentAssistantMessage) renderDbCsvDock(currentAssistantMessage);
        break;

      case 'error':
        onError(d.message);
        break;
    }
  }

  function onFinalTurn(){
    if(currentAssistantMessage){
      const cur=currentAssistantMessage.querySelector('span[style*="animation:blink"]');
      if(cur) cur.remove();
    }
    isWaiting=false; enableInput();
    orchestratorBuf=''; toolBuffers.clear();
  }
  function onError(m){
    if(!currentAssistantMessage) currentAssistantMessage=createAssistant();
    const b=mainBubble(currentAssistantMessage);
    b.innerHTML=`<div style="color:var(--err);font-weight:800;margin-bottom:6px">Error</div><div>${esc(m||'Unknown error')}</div>`;
    isWaiting=false; enableInput();
  }

  const messageInput=document.getElementById('messageInput');
  const sendButton=document.getElementById('sendButton');
  function disableInput(){ messageInput.disabled=true; sendButton.disabled=true; }
  function enableInput(){ messageInput.disabled=false; sendButton.disabled=false; messageInput.focus(); }
  function addUser(text){
    const el=document.createElement('div'); el.className='message user';
    el.innerHTML=`<div class="message-avatar" title="You">üë§</div>
      <div class="message-content"><div class="timestamp">${nowStamp()}</div><div class="message-bubble">${esc(text)}</div></div>`;
    document.getElementById('messagesContainer').appendChild(el); scrollEnd();
  }
  messageInput.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
  messageInput.addEventListener('input',function(){ this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,150)+'px'; });

  function sendMessage(){
    const txt=messageInput.value.trim();
    if(!txt || isWaiting || !ws || ws.readyState!==WebSocket.OPEN) return;
    addUser(txt);
    saveTurn('user', txt);
    maybeSetTitleFromFirstUser(txt);
    ws.send(JSON.stringify({user_input:txt}));
    messageInput.value=''; messageInput.style.height='auto';
    isWaiting=true; disableInput();
    currentAssistantMessage=null; currentToolCards.clear();
    orchestratorBuf=''; toolBuffers.clear(); toolCount=0;
    suppressOrchStream = true;
  }

  function startNewConversation() {
    startNewSession();
    renderSessionLists();
    const mc = document.getElementById('messagesContainer');
    mc.innerHTML = `<div class="message assistant">
      <div class="message-avatar" title="Assistant">
        <img src="assets/brand/logo.svg" alt="Assistant" style="width:100%;height:100%;border-radius:12px;">
      </div>
      <div class="message-content">
        <div class="timestamp">${nowStamp()}</div>
        <div class="message-bubble">Welcome to <b>BioChirp</b>! Ask me about <b>drugs</b>, <b>targets</b>, <b>diseases</b>, <b>genes</b>, <b>pathways</b>, <b>biomarkers</b>, or <b>approval status</b>.<br></div>
        <div class="samples">
          <button class="sample-chip" onclick="askSample('What are the drugs for TB?')"> üíä What are the drugs for TB?</button>
          <button class="sample-chip" onclick="askSample('Which genes are associated with asthma?')"> üß¨ Which genes are associated with asthma?</button>
          <button class="sample-chip" onclick="askSample('List all PARP inhibitors with targets and approval status')"> üß™ List all PARP inhibitors with targets and approval status</button>
        </div>
      </div>
    </div>`;
    currentAssistantMessage = null;
    currentToolCards.clear();
    orchestratorBuf = '';
    toolBuffers.clear();
    toolCount = 0;
    suppressOrchStream = false;
  }

  function askSample(t){ messageInput.value=t; sendMessage(); }

  function extractTableArray(raw){
    try{ const obj=(typeof raw==='string')?JSON.parse(raw):raw; const t=obj?.table ?? obj?.item?.output?.table; if(Array.isArray(t)) return t; }catch(e){}
    if (typeof raw === 'string'){
      const m = raw.match(/table\s*=\s*(\[[\s\S]*?\])\s*(?:\w+\s*=|$)/i);
      if (m){
        let jsonish = m[1].replace(/([{,\s])'([^']+?)'\s*:/g,'$1"$2":').replace(/:\s*'([^']*)'/g,': "$1"').replace(/None\b/g,'null').replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false');
        try{ const t = JSON.parse(jsonish); if(Array.isArray(t)) return t; }catch(e){}
      }
    }
    return null;
  }
  function toCSV(rows){
    if(!rows || !rows.length) return '';
    const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    const escv = (v)=>{ const s=(v==null?'':String(v)); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; };
    return cols.join(',')+'\n'+rows.map(r=>cols.map(c=>escv(r[c])).join(',')).join('\n');
  }

  function storeCsvOnMessage(msgEl, which, csv, name){
    if(!msgEl) return;
    msgEl.dataset[`csv_${which}`]     = csv;
    msgEl.dataset[`csvname_${which}`] = name;
  }

  function copyCSVFromCard(btn){
    const card = btn.closest('.tool-card'); const csv = card?.dataset?.csv || '';
    if (!csv) return;
    navigator.clipboard.writeText(csv).then(()=>{ btn.textContent='Copied!'; setTimeout(()=>{ btn.textContent='Copy CSV'; },900); }).catch(()=>{ btn.textContent='Copy failed'; });
  }
  function downloadCSVFromCard(btn){
    const card = btn.closest('.tool-card'); const csv = card?.dataset?.csv || ''; const name = card?.dataset?.csvFilename || 'table.csv';
    if (!csv) return;
    saveCSV(name, csv);
  }

  const SESS_KEY = 'biochirp_sessions_v1';
  const CURR_KEY = 'biochirp_current_session_id';

  function uidSession(){ return 's' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
  function getSessions(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)||'[]'); }catch{ return []; } }
  function setSessions(arr){ try{ localStorage.setItem(SESS_KEY, JSON.stringify(arr)); }catch{} }
  function getCurrentId(){ try{ return localStorage.getItem(CURR_KEY); }catch{ return null; } }
  function setCurrentId(id){ try{ localStorage.setItem(CURR_KEY, id); }catch{} }

  function ensureSession(){
    let id = getCurrentId();
    let sessions = getSessions();
    let s = sessions.find(x=>x.id===id);
    if(!s){
      if(sessions.length){ s = sessions[sessions.length-1]; setCurrentId(s.id); }
      else { return null; }
    }
    return s;
  }

  function saveTurn(role, content) {
    let s = ensureSession();
    let sessions = getSessions();
    if (!s) {
      s = { id: uidSession(), title: 'New Research Session', created: Date.now(), turns: [], tools: [] };
      sessions.push(s);
      setSessions(sessions);
      setCurrentId(s.id);
    }
    const idx = sessions.findIndex(x => x.id === s.id);
    if (idx === -1) return;
    sessions[idx].turns.push({ role, content, ts: Date.now() });

    if (role === 'assistant' && currentToolCards.size > 0) {
      const toolData = Array.from(currentToolCards.entries()).map(([id, card]) => {
        const name = card.querySelector('.tool-name')?.textContent || 'Tool';
        const output = toolBuffers.get(id) || '';
        const time = card.querySelector(`#time-${id}`)?.textContent || '‚Äî';
        return { id, name, output, time, ts: Date.now() };
      });
      sessions[idx].tools.push(...toolData);
    }
    setSessions(sessions);
  }

  function maybeSetTitleFromFirstUser(txt){
    const s = ensureSession(); if(!s) return;
    const sessions = getSessions(); const id=getCurrentId(); const idx=sessions.findIndex(x=>x.id===id);
    if(idx===-1) return;
    if(!sessions[idx].firstUserSet){
      const t = txt.trim().replace(/\s+/g,' ').slice(0,48);
      sessions[idx].title = t || 'New Research Session';
      sessions[idx].firstUserSet = true;
      setSessions(sessions);
      renderSessionLists();
    }
  }

  function renderSessionLists(){
    const sessions = getSessions();
    const cur = getCurrentId();
    const containers = [document.getElementById('sessionList'), document.getElementById('sessionListMobile')].filter(Boolean);
    containers.forEach(container=>{
      container.innerHTML = sessions.map(s=>{
        const active = s.id===cur ? 'active' : '';
        const count = (s.turns||[]).length;
        const subtitle = count ? `${count} message${count>1?'s':''}` : 'empty';
        const title = esc(s.title || 'New Research Session');
        return `<div class="conversation-item ${active}" data-session-id="${s.id}">
                  ${title}<small>${new Date(s.created||Date.now()).toLocaleDateString()} ‚Ä¢ ${subtitle}</small>
                </div>`;
      }).join('') || `<div class="conversation-item active">New Research Session</div>`;
      container.querySelectorAll('.conversation-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-session-id');
          if(!id) return;
          setCurrentId(id);
          renderSessionLists();
          restoreHistory(true);
          drawer.classList.remove('show');
        });
      });
    });
  }

  function restoreHistory(force = false) {
    const s = ensureSession();
    const mc = document.getElementById('messagesContainer');
    if (force || (s && s.turns && s.turns.length)) {
      const welcome = mc.firstElementChild?.outerHTML || '';
      mc.innerHTML = welcome;
    }
    if (!s || !s.turns || !s.turns.length) { scrollEnd(); return; }

    s.turns.forEach(m => {
      if (m.role === 'user') {
        const el = document.createElement('div');
        el.className = 'message user';
        el.innerHTML = `<div class="message-avatar" title="You">üë§</div>
          <div class="message-content">
            <div class="timestamp">${new Date(m.ts).toLocaleString()}</div>
            <div class="message-bubble">${esc(m.content)}</div>
          </div>`;
        mc.appendChild(el);
      } else {
        const el = createAssistant();
        const b = mainBubble(el);
        b.innerHTML = marked.parse(m.content || '');
        b.querySelectorAll('pre code').forEach(c => hljs.highlightElement(c));
        enhanceCode(b);

        if (s.tools && s.tools.length) {
          const relevantTools = s.tools.filter(tool => tool.ts >= m.ts - 1000 && tool.ts <= m.ts + 1000);
          relevantTools.forEach(tool => {
            const card = createToolCard(tool.id, tool.name);
            const mc2 = el.querySelector('.message-content');
            const main = mc2.querySelector('.message-bubble:not(.tool-card .message-bubble)');
            if (main) mc2.insertBefore(card, main); else mc2.appendChild(card);
            renderToolOutput(card, tool.output, tool.name);
            card.querySelector('.tool-status').textContent = 'Completed (tap to view)';
            card.querySelector('.tool-status').className = 'tool-status completed';
            card.querySelector(`#time-${tool.id}`).textContent = tool.time;
            currentToolCards.set(tool.id, card);
          });
          renderDbCsvDock(el);
        }
      }
    });
    scrollEnd();
  }

  function startNewSession(){
    const sessions = getSessions();
    const s = { id: uidSession(), title: 'New Research Session', created: Date.now(), turns: [] };
    sessions.push(s); setSessions(sessions); setCurrentId(s.id);
  }

  function deleteChat(){
    const id = getCurrentId();
    let sessions = getSessions().filter(s=>s.id!==id);
    setSessions(sessions);
    setCurrentId(null);
    renderSessionLists();
    restoreHistory(true);
  }

  function setVh() { document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px'); }
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', setVh);
  setVh();

  // ====== SHARE SNAPSHOT ======
  async function shareCurrentSession(){
    try{
      const html = buildShareHTML();
      const title = document.querySelector('.chat-title')?.textContent?.trim() || 'BioChirp Chat';
      const res = await fetch('/share', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ html, title })
      });
      if(!res.ok){
        const t = await res.text().catch(()=>String(res.status));
        throw new Error(`Share failed: HTTP ${res.status} ? ${t}`);
      }
      const data = await res.json();
      showShareDialog(data.url, data.expires_in_seconds);
    }catch(err){
      console.error(err);
      alert('Failed to create share link.\n' + (err?.message || 'Unknown error'));
    }
  }

  function showShareDialog(url, ttl){
    const seconds = Number(ttl||0);
    const days = seconds ? (seconds/86400).toFixed(1) : '?';
    const dlg = document.createElement('div');
    dlg.style.cssText = `position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,.45)`;
    dlg.innerHTML = `
      <div style="background:var(--bg1); color:var(--txt); border:1px solid var(--brd); border-radius:12px; width:min(96vw,640px); padding:16px;">
        <div style="font-weight:800; font-size:16px; margin-bottom:8px">Share link created</div>
        <div style="font-size:13px; color:var(--mut); margin-bottom:8px">Anyone with this link can view this chat snapshot. Expires in ~${days} day(s).</div>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px">
          <input id="shareLinkInput" value="${url}" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--brd); background:var(--bg2); color:var(--txt)" readonly />
          <button class="reconnect" onclick="copyShareLink()">Copy</button>
          <a class="reconnect" href="${url}" target="_blank" rel="noopener">Open</a>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px">
          <button class="reconnect" onclick="this.closest('div[style*=&quot;z-index:9999&quot;]').remove()">Close</button>
        </div>
      </div>`;
    document.body.appendChild(dlg);
    window.copyShareLink = ()=>{
      const inp = dlg.querySelector('#shareLinkInput');
      inp.select(); inp.setSelectionRange(0, 99999);
      try{ document.execCommand('copy'); }catch{}
      navigator.clipboard?.writeText(inp.value).catch(()=>{});
    };
  }

  function buildShareHTML(){
    const live  = document.getElementById('messagesContainer');
    const clone = live.cloneNode(true);

    const removeSel = [
      '.copy-btn', '.sidebar', '.input-area', '.sidebar-toggle',
      '.reconnect#reconnectBtn', '.status-wrap', '.run-summary',
      '#drawer', '.drawer', '#drawerOpen', '#drawerClose',
      '.csv-frame button', '.sample-chip'
    ].join(',');

    clone.querySelectorAll('span[style*="animation:blink"]').forEach(n=>n.remove());
    clone.querySelectorAll(removeSel).forEach(n=>n.remove());
    clone.querySelectorAll('*').forEach(el=>{
      [...el.attributes].forEach(a=>{ if(/^on/i.test(a.name)) el.removeAttribute(a.name); });
    });

    const titleTxt = (document.querySelector('.chat-title')?.textContent || 'BioChirp Chat').trim();
    const when = new Date().toLocaleString();

    const minimalCSS = `
      *{box-sizing:border-box}
      body{margin:0;background:#0B1222;color:#EAF2FF;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
      .wrap{max-width:980px;margin:0 auto;padding:18px}
      .hdr{display:flex;align-items:baseline;justify-content:space-between;gap:12px;padding:8px 0 14px;border-bottom:1px solid rgba(255,255,255,.12)}
      .hdr h1{margin:0;font-size:18px}
      .hdr .meta{color:#9FB0C4;font-size:12px}
      .message{display:flex;gap:12px;max-width:900px;margin:10px 0}
      .message-avatar{width:32px;height:32px;border-radius:8px;background:#101a2c;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.08)}
      .message-content{flex:1}
      .timestamp{font-size:11px;color:#9FB0C4;margin-bottom:4px}
      .message-bubble{padding:14px 16px;border-radius:14px;background:#0F1828;border:1px solid rgba(255,255,255,.10);line-height:1.6;font-size:15px}
      pre{background:#0E1626;border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:12px;overflow:auto}
      code{background:#0E1626;border:1px solid rgba(255,255,255,.10);border-radius:6px;padding:2px 6px}
      table{border-collapse:separate;border-spacing:0;width:100%;background:#0F1828;border:1px solid rgba(255,255,255,.10);border-radius:11px}
      thead th{position:sticky;top:0;background:#121C2E;color:#EAF2FF;padding:10px 12px;text-align:left;font-size:13px}
      tbody td{padding:9px 12px;border-bottom:1px solid rgba(255,255,255,.10);color:#EAF2FF}
      caption{text-align:left;color:#1FA4FF;padding:8px 6px 6px;font-weight:800}
      .tool-card,.tool-card .tool-header,.tool-card .tool-body,.tool-card .tool-output,.tool-card table{background:#fff;color:#222}
      .tool-card{border:1px solid #e6e6e6;border-radius:12px;margin:10px 0}
      .tool-header{padding:10px 12px;border-bottom:1px solid #eee}
      .tool-output{padding:12px;white-space:pre-wrap;word-break:break-word}
      .csv-dock{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:12px 0 0}
      .csv-frame{background:#0F1828;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px}
      .csv-actions{display:flex;gap:10px;align-items:center;margin-top:6px}
      .csv-actions .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 13px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#122033;color:#EAF2FF;font-weight:700;font-size:13px}
      .csv-actions .btn-download{background:linear-gradient(135deg,#1FA4FF,#A78BFA);color:#00162a;border:none}
    `;

    const contentHTML = clone.innerHTML;

    return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${escapeHtml(titleTxt)} ‚Äî Snapshot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>${minimalCSS}</style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h1>${escapeHtml(titleTxt)}</h1>
      <div class="meta">Shared on ${escapeHtml(when)} (read-only snapshot)</div>
    </div>
    <section id="messagesContainer">${contentHTML}</section>
  </div>
</body>
</html>`;
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  }

  function viewCsvInline(csvText, maxLines = 100, title = 'CSV preview') {
    const w = window.open('', '_blank', 'noopener,noreferrer');
    if (!w) { alert('Popup blocked. Please allow popups for this site.'); return; }
    const lines = String(csvText || '').split(/\r?\n/).slice(0, maxLines).join('\n');
    w.document.open();
    w.document.write(`<!doctype html>
<html lang="en"><head><meta charset="utf-8"><title>${title}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>:root{--bg:#0B1222;--card:#0F1828;--txt:#EAF2FF;--mut:#9FB0C4;}body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-monospace,Menlo,Consolas,monospace}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid rgba(255,255,255,.12);padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
.meta{color:var(--mut);font-size:12px}pre{margin:0;padding:12px;white-space:pre;overflow:auto}
button{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#122033;color:var(--txt);cursor:pointer}
button:hover{background:#172840}</style></head>
<body><header><div><strong>${title}</strong> ‚Äî first ${maxLines} line(s)</div><div class="meta">(download from here if needed)</div><div><button id="dlBtn">Download CSV</button></div></header><pre id="csvPre"></pre></body></html>`);
    w.document.close();
    w.document.getElementById('csvPre').textContent = lines;
    const dlBtn = w.document.getElementById('dlBtn');
    dlBtn.onclick = () => {
      const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
      const a = w.document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'results.csv';
      w.document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    };
  }
  // ====== END SHARE SNAPSHOT ======
</script>
</body>
</html>
