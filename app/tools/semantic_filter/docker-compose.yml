
# # services:

# #   biochirp_semantic_embedding:
# #     build:
# #       context: ../biochirp_embedding_tool
# #       container_name: biochirp_semantic_embedding
# #       image: biochirp_semantic_embedding:latest
# #       ports:
# #         - "8003:8003"
# #       restart: unless-stopped

# #     healthcheck:
# #       test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
# #       interval: 20s
# #       timeout: 20s
# #       retries: 5

# #     networks:
# #       - semantic_net

# #   biochirp_semantic_tool:
# #     build: .
# #     container_name: biochirp_semantic_tool
# #     image: biochirp_semantic_tool:latest
# #     ports:
# #       - "8015:8015"
# #     networks:
# #       - semantic_net

# #     restart: unless-stopped

# #     environment:
# #       - TZ=Asia/Kolkata
# #       - PYTHONUNBUFFERED=1
# #       - BIOCHIRP_EMBEDDING_PORT=8003
# #       - BIOCHIRP_EMBEDDING_HOST=biochirp_semantic_embedding

# #     env_file:
# #       - ../../../.env

# #     volumes:
# #       - ../../../config/guardrail.py:/app/config/guardrail.py:ro
# #       - ../../../config/settings.py:/app/config/settings.py:ro
# #       - ../../../config/__init__.py:/app/config/__init__.py:ro
# #       - ../../../resources/prompts/:/app/resources/prompts/:ro
# #       - ../../../resources/values/concept_values_by_db_and_field.pkl:/app/resources/values/concept_values_by_db_and_field.pkl:ro
# #       # - ../../services/semantic_matching.py:/app/services/semantic_matching.py:ro


# #     healthcheck:
# #       test: ["CMD", "curl", "-f", "http://localhost:8015/health"]
# #       interval: 20s
# #       timeout: 20s
# #       retries: 5

        
# #     depends_on:
# #       - biochirp_semantic_embedding
# #     networks:
# #       - semantic_net







# # # networks:
# # #   semantic_net:
# # #     external: true



# services:

#   biochirp_qdrant:
#     image: qdrant/qdrant
#     container_name: biochirp_qdrant
#     ports:
#       - "6333:6333"
#       - "6334:6334"
#     networks:
#       - semantic_net
#     restart: unless-stopped


#   biochirp_semantic_embedding:
#     build:
#       context: ../bioc_embedding
#     container_name: biochirp_semantic_embedding
#     image: biochirp_semantic_embedding:latest
#     ports:
#       - "8003:8003"
#     restart: unless-stopped

#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
#       interval: 20s
#       timeout: 20s
#       retries: 5

#     networks:
#       - semantic_net

#   biochirp_semantic_tool:
#     build: .
#     container_name: biochirp_semantic_tool
#     image: biochirp_semantic_tool:latest
#     ports:
#       - "8015:8015"
#     restart: unless-stopped

#     environment:
#       - TZ=Asia/Kolkata
#       - PYTHONUNBUFFERED=1
#       - BIOCHIRP_EMBEDDING_PORT=8003
#       - BIOCHIRP_EMBEDDING_HOST=biochirp_semantic_embedding

#     env_file:
#       - ../../../.env

#     volumes:
#       - ../../../config/guardrail.py:/app/config/guardrail.py:ro
#       - ../../../config/settings.py:/app/config/settings.py:ro
#       - ../../../config/__init__.py:/app/config/__init__.py:ro
#       - ../../../resources/prompts/:/app/resources/prompts/:ro
#       - ../../../resources/values/concept_values_by_db_and_field.pkl:/app/resources/values/concept_values_by_db_and_field.pkl:ro
#       # - ../../services/semantic_matching.py:/app/services/semantic_matching.py:ro

#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:8015/health"]
#       interval: 20s
#       timeout: 20s
#       retries: 5

#     depends_on:
#       - biochirp_semantic_embedding

#     networks:
#       - semantic_net

# networks:
#   semantic_net:
#     driver: bridge



services:

  # biochirp_qdrant:
  #   image: qdrant/qdrant
  #   container_name: biochirp_qdrant
  #   ports:
  #     - "6333:6333"
  #     - "6334:6334"
  #   networks:
  #     - semantic_net
  #   restart: unless-stopped


  biochirp_llm_filter_tool:
    build:
      context: ../llm_member_filter
      dockerfile: Dockerfile
    image: biochirp_llm_filter_tool:latest
    container_name: biochirp_llm_filter_tool
    ports:
      - "8017:8017"
    environment:
      - TZ=Asia/Kolkata
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    env_file:
      - ../../../.env
    volumes:
      - ../../../config/guardrail.py:/app/config/guardrail.py:ro
      - ../../../resources/prompts/:/app/resources/prompts/:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8017/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: "1.0"
        reservations:
          memory: 256m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - semantic_net


  biochirp_embedding_tool:
    build:
      context: ../bioc_embedding
    container_name: biochirp_embedding_tool
    image: biochirp_embedding_tool:latest
    ports:
      - "8003:8003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 20s
      timeout: 20s
      retries: 5

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - semantic_net

  biochirp_semantic_tool:
    build: .
    container_name: biochirp_semantic_tool
    image: biochirp_semantic_tool:latest
    ports:
      - "8015:8015"
    restart: unless-stopped
    environment:
      - TZ=Asia/Kolkata
      - PYTHONUNBUFFERED=1
      - BIOCHIRP_EMBEDDING_PORT=8003
      - BIOCHIRP_EMBEDDING_HOST=biochirp_embedding_tool
      # - QDRANT_HOST=biochirp_qdrant      # <--- ADD THIS LINE
      # - QDRANT_PORT=6334                 # <--- ADD THIS LINE IF YOUR CODE NEEDS IT
    env_file:
      - ../../../.env
    volumes:
      - ../../../config/guardrail.py:/app/config/guardrail.py:ro
      - ../../../config/settings.py:/app/config/settings.py:ro
      - ../../../config/__init__.py:/app/config/__init__.py:ro
      - ../../../resources/prompts/:/app/resources/prompts/:ro
      - ../../../resources/values/concept_values_by_db_and_field.pkl:/app/resources/values/concept_values_by_db_and_field.pkl:ro
      # - ../../services/semantic_matching.py:/app/services/semantic_matching.py:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8015/health"]
      interval: 20s
      timeout: 20s
      retries: 5
    depends_on:
      - biochirp_embedding_tool
      # - biochirp_qdrant        # <--- ADD THIS DEPENDENCY
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    networks:
      - semantic_net

# networks:
#   semantic_net:
#     driver: bridge


networks:
  semantic_net:
    external: true
  